<!doctype html><html lang=ja><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>o | ISUCON 12 予選 参加記</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link href=/dist/app.css rel=stylesheet><script>(function(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(e)}),i.parentNode.insertBefore(n,i)})("https://omuric.github.io/lib/pangu.min.js",function(){pangu.spacingPage()})</script></head><body class="bg-gray-100 text-gray-700 font-sans"><div class="p-6 sm:p-10 md:p-16 flex flex-wrap"><header class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-1 md:order-1 max-w-2xl"><div class="z-50 bg-gray-100 bg-opacity-75 bg-opacity-custom lg:min-w-0.7 max-w-xl md:float-right md:text-right leading-loose tracking-tight md:sticky md:top-0 pt-2"><div><h2><a href=https://omuric.github.io/ title=o class="heading font-cursive icon">o</a></h2></div><h1 class=pt-2>ISUCON 12 予選 参加記</h1><div class="flex flex-wrap justify-end pt-2"><div class="md:flex-grow-0 font-light"></div><time class="text-eucalyptus-500 md:text-right md:flex-grow font-light pl-4" datetime=2022-07-24T17:00:00+09:00>2022-7-24 17:00</time></div><hr></div></header><main role=main class="w-full md:w-3/5 xl:w-1/2 max-w-3xl order-2 md:order-2 min-h-70vh pt-2 pb-4"><article><section class="mx-auto content"><div class=c-rich-text><h1 id=isucon-12-予選-参加記>ISUCON 12 予選 参加記</h1><p>2022年 7月23日 (土) に開催された ISUCON 12 の予選にチームO (dice801, daiju, omu) で Rust で参加しました<br>自分達の最終結果は 25598 点で、20位で予選突破しました。<br>(<a href=https://isucon.net/archives/56838276.html>最終結果一覧</a>)</p><p><img src=https://omuric.github.io/isucon12-qualify/benchmark.png alt></p><h2 id=事前準備>事前準備</h2><ul><li><a href=https://omuric.github.io/posts/isucon10-qualify/>ISUCON 10</a> や ISUCON 11 で使ったツール類を準備<ul><li><a href=https://github.com/sagiegurari/cargo-make>cargo-make</a><ul><li>各操作を定義してデプロイや kataribe, pt-query-digest の実行など、コマンド一発で諸々できるようにしていた</li><li>↓の感じで各操作の通知が discord に来る感じにもしていた</li><li><img src=https://omuric.github.io/isucon12-qualify/notify.jpeg alt></li></ul></li><li><a href=isuconf>https://github.com/omuric/isuconf</a><ul><li>設定ファイルの管理を行うために自前で用意した CLI ツール</li><li>各インスタンスの設定ファイルの収集・配布を簡単に出来るやつ</li><li>去年の予選時にこしらえたもので、今年も幾つか機能追加をした (push, pull 操作の並列化や ssh-config 生成のサポートなど)</li><li>我ながらそこそこ便利で、去年のチームメンバが別のチームでも布教してくれていて嬉しかったです</li></ul></li></ul></li><li>[https://github.com/launchbadge/sqlx] での典型的な DB 操作の素振り<ul><li>普段使わないので本番でハマりがちという反省から</li><li>in 句による select や bulk insert などの典型と思われるものを練習した</li></ul></li><li>[https://github.com/hinohi/rust-opentelemetry-auto-span]<ul><li>チームメンバの daiju さんが作った sqlx, reqwest の opentelemetry スパン挿入を簡単にするやつ</li><li>関数にアノテーションをつけるだけでボトルネックが見えるようになり最高でした</li></ul></li></ul><h2 id=チームでやったこと>チームでやったこと</h2><ul><li>N+1 クエリの解消</li><li>sqlite から mysql への移行</li><li>アプリケーションサーバと DB サーバの分離</li><li>テーブルの圧縮<ul><li>visit_history</li><li>player_score</li></ul></li></ul><p>TBW</p><h2 id=当日自分がやったこと>当日自分がやったこと</h2><ul><li>N+1 クエリの解消<ul><li>コミットログ見ると4つぐらい直したみたいです<ul><li>competition_ranking_handler の N+1 を修正</li><li>player_handler の N+1 を解消</li><li>player_score を bulk insert</li><li>competition_score_handler の N+1 を修正</li></ul></li></ul></li><li>player_score 圧縮のアプリ側の対応<ul><li>row_num が一番大きいものだけを残せばいいのでそうする</li><li>初期データの修正は daiju さんが sqlite -> mysql への切替時に合わせてやってくれていました</li></ul></li><li>sqlite -> mysql への切り替えのアプリ側の対応<ul><li>コード中の sqlite への接続箇所を mysql に切り替える対応</li><li>データ構造の設計や切り替えは daiju さんが全てやってくれていました</li></ul></li><li>dispense_id の生成処理修正<ul><li>アプリ側で UUID を生成する形に変更</li></ul></li><li>pem ファイルをプログラム起動時に読み込む<ul><li>リクエスト毎にファイル読み込みをしていたので修正</li><li>コードリーディング時にパッと目についたので直したけど余り意味なかったかも</li></ul></li></ul><h2 id=良かったこと>良かったこと</h2><ul><li>Rust での参加<ul><li>Rust で出るのは三回目ですが、ORM 周り (というか sqlx) ぐらいでしかバグは出ず改めて良い言語だなという感想</li></ul></li><li>ツール類による効率化<ul><li>ツールによる自動化で主要な操作はコマンド一発で対応できていて体験が良かった</li><li>本質的な改善活動に集中出来た</li></ul></li></ul><h2 id=反省点>反省点</h2><ul><li>アプリサーバの分離が間に合わなかった<ul><li>最終的な構成はアプリサーバ1台 DBサーバ1台で、1台サーバを余らせている状態だった</li><li>アプリの CPU がきつそうだったので、アプリサーバを2台にしたかったが、flock の引き剥がしが間に合わず対応できなかった</li><li>複数のアプリの状態管理に対する素振りが足りていなかったかなという反省</li></ul></li><li>方針決めにあまり貢献できなかったこと<ul><li>大きな変更 (sqlite の mysql への切り替え) の方針については主に daiju さん, dice801 さんが会話して方針を決めていた</li><li>自分は決まった方針に対して必要な一部タスクを実施する人になっており、方針決めに頭を使えなかったのは反省</li></ul></li></ul><h2 id=感想>感想</h2><p>今年で ISUCON に参加するのは 5年目ですが、ようやく初めて予選突破できました。<br>優秀なチームメンバと良いチームワークで問題に取り組めたのが良かったのかなと思います。<br>本戦でもチームに貢献して良い成績を取れるよう頑張りたいです。</p></div></section></article></main><aside role=contentinfo class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-4 md:order-3 md:sticky md:bottom-0 self-end max-w-2xl"><div class="md:float-right md:text-right leading-loose tracking-tight md:mb-2"><div class="md:max-w-xs flex flex-col md:items-end"><ul class="font-serif flex-grow-0 flex justify-between flex-wrap md:flex-col"></ul><div class="flex flex-wrap-reverse md:justify-end content-end md:content-start justify-start items-start max-h-16"></div><div class="text-sm text-gray-500 leading-tight a-gray"><br>Built with Hugo and theme <a href=https://github.com/heyeshuang/hugo-theme-tokiwa>Tokiwa</a>. 176 words in this page.</div></div></div></aside><footer class="w-full md:w-3/5 xl:w-1/2 order-3 max-w-3xl md:order-4 pt-2"><hr class=double-line><div class="flex flex-wrap justify-between pb-2 leading-loose font-serif"><a class=flex-grow-0 href=/posts/icfp-pc2021/><svg class="fill-current inline-block h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7.828 11H20v2H7.828l5.364 5.364-1.414 1.414L4 12l7.778-7.778 1.414 1.414z"/></svg>ICFP-PC 2021 参加記</a></div><div></div><hr><div class=pb-2></div><hr></footer><script src=/dist/app.js></script></div></body></html>